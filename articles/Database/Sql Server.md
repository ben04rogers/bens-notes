## Installation

### Local Server Instance
```
winget install -e --id Microsoft.SQLServer.2019.Express
winget install -e --id Microsoft.SQLServer.2019.Developer --override '/QUIET /IACCEPTSQLSERVERLICENSETERMS /CONFIGURATIONFILE="C:\Dev\SQLConfigurationFile.ini"'
```
**SQLConfigurationFile.ini**
  ```
  ; Microsoft SQL Server Configuration file  
  [OPTIONS]  
  ; Specifies a Setup work flow, like INSTALL, UNINSTALL, or UPGRADE.  
  ; This is a required parameter.  
  ACTION="Install"  
  ; Specifies features to install, uninstall, or upgrade.  
  ; The list of top-level features include SQL, AS, RS, IS, and Tools.  
  ; The SQL feature will install the database engine, replication, and full-text.  
  ; The Tools feature will install Management Tools, Books online,   
  ; SQL Server Data Tools, and other shared components.  
  FEATURES=SQL,Tools
  INSTANCENAME=SQL2019Dev
  SQLSYSADMINACCOUNTS="[Domain]\[Username]"
  SECURITYMODE=SQL
  SAPWD="S4P4ssw0rd"
  ```
  
### Docker Image
```
docker pull mcr.microsoft.com/mssql/server:2019-latest
docker pull mcr.microsoft.com/mssql/server:2022-latest
```

### SQL Server Management Studio
```
winget install -e --id Microsoft.SQLServerManagementStudio
winget upgrade -e --id Microsoft.SQLServerManagementStudio
```

### Sqlcmd Tools
```
winget install -e --id Microsoft.Sqlcmd
winget upgrade -e --id Microsoft.Sqlcmd
```


## Documentation
- [Install SQL Server from the Command Prompt](https://docs.microsoft.com/en-us/sql/database-engine/install-windows/install-sql-server-from-the-command-prompt)
- [Install SQL Server using a configuration file](https://docs.microsoft.com/en-us/sql/database-engine/install-windows/install-sql-server-using-a-configuration-file)

## EF vs. Stored Procedures
- [Entity Framework Vs Stored Procedures - Performance Measure](https://stackoverflow.com/questions/9739230/entity-framework-vs-stored-procedures-performance-measure)
- [Performance Considerations (Entity Framework)](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/ef/performance-considerations?redirectedfrom=MSDN)
- [What are the pros and cons of using stored procedures vs C# code for DB work?](https://docs.microsoft.com/en-us/answers/questions/236924/what-are-the-pros-and-cons-of-using-stored-procedu.html)
## SQL Performance
- [[Performance]]
## Resources
- [Brent Ozar](https://www.brentozar.com/)
- [SQL Kit](https://sqlserver-kit.org/en)

## Retries

Enable transient error resiliency by adding `EnableRetryOnFailure` to the `UseSqlServer` call on [[ASP.NET]]

## Useful Commands

`sp_helptext`
## Useful Queries

[[Useful SQL Server Queries]]

## Encryption by Certificate
- https://docs.microsoft.com/en-us/sql/t-sql/functions/encryptbycert-transact-sql
- https://docs.microsoft.com/en-us/sql/t-sql/functions/decryptbycert-transact-sql
- https://docs.microsoft.com/en-us/sql/t-sql/statements/create-certificate-transact-sql
- https://docs.microsoft.com/en-us/sql/t-sql/statements/alter-certificate-transact-sql
## Encryption by Password
### 1 - Create Symmetric Key (one-off)

Encryption keys are generated by running the [CREATE SYMMETRIC KEY](https://docs.microsoft.com/en-us/sql/t-sql/statements/create-symmetric-key-transact-sql) command.

```sql
CREATE SYMMETRIC KEY [SymKey_SomeID] WITH ALGORITHM = AES_256,
KEY_SOURCE = 'KEY_SOURCE_STRING',
IDENTITY_VALUE = 'IDENTITY_VALUE_STRING' ENCRYPTION BY PASSWORD = 'eLtGc5woM&S$n5'

-- View the newly created encryption
SELECT * 
FROM sys.symmetric_keys

-- View the actual key data. At its lowest level, a 256 bit AES key is comprised of 256 bits (32 bytes) of data.
SELECT * 
FROM sys.key_encryptions
```
### 2 - Open Symmetric Key

A symmetric encryption key must be opened using the [OPEN SYMMETRIC KEY](https://docs.microsoft.com/en-us/sql/t-sql/statements/open-symmetric-key-transact-sql) command before it can be used. 

```sql
OPEN SYMMETRIC KEY [SymKey_SomeID] 
DECRYPTION BY PASSWORD = 'eLtGc5woM&S$n5'
```
### 3 - Encrypt Data

Data can be encrypted using the SQL function [ENCRYPTBYKEY](https://docs.microsoft.com/en-us/sql/t-sql/functions/encryptbykey-transact-sql).

The *authenticator* value is used as an additional piece of data against which the encryption will be validated. If the same context (including *authenticator*) is not provided again when decrypting, then decryption will fail.

The following SQL statement demonstrates encrypting a string using a GUID value as an *authenticator*:

```sql
DECLARE @keyId UNIQUEIDENTIFIER = (SELECT key_guid FROM sys.symmetric_keys WHERE name='SymKey_SomeID')
DECLARE @auth VARCHAR(40) = '7AECFD07-4643-41FC-B17C-472AD71699E7'
DECLARE @str VARCHAR(50) = 'Super secret string data'
SELECT ENCRYPTBYKEY(@keyId, @str, 1, @auth)
```
### 4 - Decrypt Data

```sql
DECLARE @encryptedData VARBINARY(200) = 0x00983DD06D6B6AC67A112F2A8866927A020000005A05FE279810FC3A75B27979324C9C81EBCE0D65AD8E2312ACBC5E23A49F135FFE44453511432DDF7C68D764865DE75C12F692E50B0B6EC5F3FD2C0E4C2C68DE5EEB8F773DA407DA32D6C79C5EF6F0BA
DECLARE @auth VARCHAR(40) = '7AECFD07-4643-41FC-B17C-472AD71699E7'
SELECT CONVERT(VARCHAR(100), DECRYPTBYKEY(@encryptedData, 1, @auth))
```
## Troubleshooting

---
**Error:** 'Agent XPs' component is turned off as part of the security configuration for this server. A system administrator can enable the use of 'Agent XPs' by using sp_configure. For more information about enabling 'Agent XPs', see "Surface Area Configuration" in SQL Server Books Online. (Microsoft.SqlServer.Management.MaintenancePlanWizard)

**Solution:**
  ```sql
  sp_configure 'show advanced options', 1;  
  GO  
  RECONFIGURE;  
  GO  
  sp_configure 'Agent XPs', 1;  
  GO  
  RECONFIGURE  
  GO
  ```

---
**Error:** SQLServerAgent is not currently running so it cannot be notified of this action. (Microsoft SQL Server, Error: 22022)

**Solution:** Open SQL Server Configuration Manager and enable SQL Server Agent Service

---

**Error:** Cannot execute as the database principal because the principal ‘dbo’ does not exist, this type of principal cannot be impersonated, or you do not have permission. (Microsoft SQL Server, Error: 15517)

**Solution:**
  ```sql
  USE [AdventureWorks]
  GO
  ALTER AUTHORIZATION ON DATABASE::[AdventureWorks] TO [sa]
  GO
  ```

---

## Performance
  
- [Performance Center for SQL Server Database](https://docs.microsoft.com/en-us/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database?view=sql-server-ver16)
- [Start and use the Database Engine Tuning Advisor](https://docs.microsoft.com/en-us/sql/relational-databases/performance/start-and-use-the-database-engine-tuning-advisor?view=sql-server-ver16)
- [Monitor performance by using the Query Store](https://docs.microsoft.com/en-us/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store?view=sql-server-ver16)
- [Use the Maintenance Plan Wizard](https://docs.microsoft.com/en-us/sql/relational-databases/maintenance-plans/use-the-maintenance-plan-wizard)


